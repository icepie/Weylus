# 多阶段构建 - 优化版本
# 这个版本支持更好的缓存和更小的最终镜像

# ============================================
# 阶段1: 构建环境
# ============================================
FROM ubuntu:20.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive

# 安装构建依赖
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    libx11-dev \
    libxtst-dev \
    libglib2.0-dev \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    libdbus-1-dev \
    git \
    nasm \
    yasm \
    cmake \
    libva-dev \
    libdrm-dev \
    && rm -rf /var/lib/apt/lists/*

# 安装Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# 设置工作目录
WORKDIR /build

# 先复制依赖文件，利用Docker缓存
COPY Cargo.toml Cargo.lock ./
COPY lib/ ./lib/

# 创建虚拟main.rs触发依赖下载
RUN mkdir -p src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build --release || true && \
    rm -rf src

# 复制真实源代码
COPY src/ ./src/

# 编译
RUN cargo build --release

# 检查编译结果
RUN ls -lh target/release/weylus && \
    echo "Binary size:" && \
    du -h target/release/weylus

# ============================================
# 阶段2: 运行时环境（可选，用于创建Docker镜像）
# ============================================
FROM ubuntu:20.04 AS runtime

RUN apt-get update && apt-get install -y \
    libx11-6 \
    libxtst6 \
    libglib2.0-0 \
    libgstreamer1.0-0 \
    libgstreamer-plugins-base1.0-0 \
    libdbus-1-3 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /build/target/release/weylus /usr/local/bin/weylus

EXPOSE 1701

ENTRYPOINT ["weylus"]

# ============================================
# 阶段3: 输出二进制（默认）
# ============================================
FROM builder AS output
CMD ["cp", "/build/target/release/weylus", "/output/weylus"]
